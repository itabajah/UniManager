name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create Firebase Config
        run: |
          # Secrets-only deployment: generate runtime config during deploy.
          # If secrets are missing, fail so we don't ship a broken site.
          if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then
            echo "Missing GitHub Secret: FIREBASE_API_KEY"
            echo "Add Firebase secrets in: Repo Settings → Secrets and variables → Actions"
            exit 1
          fi

          mkdir -p js
          cat > js/firebase-config.js << 'EOF'
          /**
           * Firebase runtime config (generated during deploy)
           * This repo loads Firebase via <script> tags, so we expose FIREBASE_CONFIG globally.
           */
          'use strict';
          
          // eslint-disable-next-line no-unused-vars
          const FIREBASE_CONFIG = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          EOF
          test -f js/firebase-config.js
          echo "✓ Created js/firebase-config.js"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
